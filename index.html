<!DOCTYPE html>
<html>

<head>
    <title>è‡ªç„¶ç§‘å­¦éƒ¨ã‚ã—ã‚ã¨ğŸ¾QR</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="è‡ªç„¶ç§‘å­¦éƒ¨, æ˜‡é¾ç¥­, QRå…¥é€€å ´ã‚·ã‚¹ãƒ†ãƒ ">
    <meta name="description" content="è‡ªç„¶ç§‘å­¦éƒ¨PCç­ã®æ˜‡é¾ç¥­ã«ã¦ã‚¨ãƒªã‚¢ã”ã¨ã®æ··é›‘çŠ¶æ³ãŒç¢ºèªã§ãã‚‹QRå…¥é€€å ´ã‚·ã‚¹ãƒ†ãƒ ">
    <link rel="stylesheet" href="index.css">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=0.2, maximum-scale=4,user-scalable=yes">
    <!-- jsQR.jsã®èª­ã¿è¾¼ã¿ -->
    <script src="./dist/jsQR.js"></script>
    <script>
        var video, tmp, tmp_ctx, qr, prev, prev_ctx, w, h, m, x1, y1;
        window.addEventListener("load", function () {
            video = document.createElement('video');
            video.setAttribute("autoplay", "");
            video.setAttribute("muted", "");
            video.setAttribute("playsinline", "");
            video.onloadedmetadata = function (e) { video.play(); };
            prev = document.getElementById("preview");
            prev_ctx = prev.getContext("2d");
            tmp = document.createElement('canvas');
            tmp_ctx = tmp.getContext("2d");

            qr = document.getElementById("qr");
            //ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã®è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
            navigator.mediaDevices.getUserMedia(
                //ãƒã‚¤ã‚¯ã¯ã‚ªãƒ•, ã‚«ãƒ¡ãƒ©ã®è¨­å®š   ã§ãã‚Œã°èƒŒé¢ã‚«ãƒ¡ãƒ©    ã§ãã‚Œã°640Ã—480
                { "audio": false, "video": { "facingMode": "environment", "width": { "ideal": 640 }, "height": { "ideal": 480 } } }
            ).then( //è¨±å¯ã•ã‚ŒãŸå ´åˆ
                function (stream) {
                    video.srcObject = stream;
                    //0.5ç§’å¾Œã«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
                    setTimeout(Scan, 500);
                }
            ).catch( //è¨±å¯ã•ã‚Œãªã‹ã£ãŸå ´åˆ
                function (err) { qr.innerHTML = qr.innerHTML + err + '\n'; }
            );
        });
        function Scan() {
            //é¸æŠã•ã‚ŒãŸå¹…é«˜ã•
            w = video.videoWidth;
            h = video.videoHeight;
            //ç”»é¢ä¸Šã®è¡¨ç¤ºã‚µã‚¤ã‚º
            prev.style.width = (w / 2) + "px";
            prev.style.height = (h / 2) + "px";
            //å†…éƒ¨ã®ã‚µã‚¤ã‚º
            prev.setAttribute("width", w);
            prev.setAttribute("height", h);
            if (w > h) { m = h * 0.5; } else { m = w * 0.5; }
            x1 = (w - m) / 2;
            y1 = (h - m) / 2;
            prev_ctx.drawImage(video, 0, 0, w, h);
            prev_ctx.beginPath();
            prev_ctx.strokeStyle = "rgb(255,0,0)";
            prev_ctx.lineWidth = 2;
            prev_ctx.rect(x1, y1, m, m);
            prev_ctx.stroke();
            tmp.setAttribute("width", m);
            tmp.setAttribute("height", m);
            tmp_ctx.drawImage(prev, x1, y1, m, m, 0, 0, m, m);
            let imageData = tmp_ctx.getImageData(0, 0, m, m);
            let scanResult = jsQR(imageData.data, m, m);
            if (scanResult) {
                //QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸçµæœã‚’å‡ºåŠ›
                qr.value = qr.value + scanResult.data + '\n';
                qr.scrollTop = qr.scrollHeight;
            }
            setTimeout(Scan, 200);
        }
    </script>
</head>

<body>
    <p>ãƒ”ãƒ³ãƒˆã‚’åˆã‚ã›ã¦ã€QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©æ˜ åƒã®èµ¤æ å†…ã«ã‚ã‚ã›ã‚‹ã¨èª­ã¿å–ã‚Šã¾ã™</p>
    <div><canvas id="preview"></canvas></div>
    <textarea id="qr" rows="8" cols="40"></textarea>
</body>

</html>